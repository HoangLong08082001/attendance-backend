<script>
  async function callProtectedAPI() {
    const token = localStorage.getItem("token"); // Lấy token từ localStorage
  
    if (!token) {
      document.getElementById("login-cms").style.display = "block"; 
      return;
    }
  
    try {
      const response = await fetch("/api/admin/protectedRoute", {
        method: "GET",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}` // Gửi token trong Authorization header
        }
      });
  
      // Nếu API trả về 200 (OK), nghĩa là người dùng có quyền truy cập
      if (response.ok) {
        const result = await response.json();
        document.getElementById("login-cms").style.display = "none"; 
        window.location.href = "/dashboard"; // Chuyển hướng về trang login

      } else if (response.status === 403) {
        alert("You do not have permission to access this page.");
        localStorage.removeItem("token"); // Xóa token
        window.location.href = "/"; // Chuyển hướng về trang login
      } else {
        const result = await response.json();
        console.error(result.message);  
        window.location.href = "/"; // Chuyển hướng về trang login
        alert("An unexpected error occurred.");
      }
    } catch (error) {
      console.error("Error while accessing protected route:", error);
      alert("An error occurred. Please try again later.");
    }
  }
  
  // Chỉ tải nội dung sau khi đã xác nhận quyền truy cập
  document.addEventListener("DOMContentLoaded", callProtectedAPI);
    </script> 

<style>
  .form-group input:focus{
    color: white;
  }
</style>
<div class="container-scroller" style="width: 100%; display: none;" id="login-cms">
      <div class="container-fluid page-body-wrapper full-page-wrapper">
        <div class="row w-100 m-0">
          <div class="content-wrapper full-page-wrapper d-flex align-items-center auth login-bg">
            <div class="card col-lg-4 mx-auto">
              <div class="card-body px-5 py-5">
                <h3 class="card-title text-left mb-3">Login</h3>
                <form style="margin-top: 30px;" id="loginForm">
                  <div class="form-group">
                    <label style="color: white;">Username or email *</label>
                    <input         
                    type="text"
                    id="username"
                    name="username"
                    placeholder="Nhập Email hoặc SĐT"
                    required
                    class="form-control p_input">
                  </div>
                  <div class="form-group">
                    <label style="color: white;">Password *</label>
                    <input        
                    type="password"
                    id="password"
                    name="password"
                    placeholder="Nhập mật khẩu"
                    required
                     class="form-control p_input">
                  </div>

                  <div class="text-center">
                    <button type="submit" class="btn btn-primary btn-block enter-btn">Login</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
</div>

  <script>
document
  .getElementById("loginForm")
  .addEventListener("submit", async function (event) {
    event.preventDefault();

    const username = document.getElementById("username").value;
    const password = document.getElementById("password").value;

    try {
      const response = await fetch("/api/auth/loginCMS", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, password }),
      });

      const result = await response.json();

      if (result.token) {
        localStorage.setItem("token", result.token); // Lưu token vào localStorage

        // Hiển thị popup thông báo thành công
        showResultPopup(
          "Đăng nhập thành công",
          "Bạn sẽ được chuyển hướng tới trang quản trị.",
          () => {
            callProtectedAPI(result.token); // Sau khi đóng popup, gọi API bảo vệ
          }
        );
      } else {
        showResultPopup("Thất bại", "Sai thông tin đăng nhập. Vui lòng thử lại.");
      }
    } catch (error) {
      console.error("Error during login:", error);
      showResultPopup("Lỗi", "Đã xảy ra lỗi không mong muốn khi đăng nhập.");
    }
  });

// Gọi API bảo vệ của admin để kiểm tra quyền truy cập
async function callProtectedAPI(token) {
  try {
    const response = await fetch("/api/admin/protectedRoute", {
      method: "GET",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${token}`, // Gửi token cùng với yêu cầu
      },
    });

    if (response.status === 403) {
      // Nếu trả về 403, hiển thị thông báo và xóa token
      console.error("Access denied. Admins only.");
      showResultPopup(
        "Truy cập bị từ chối",
        "Bạn không có quyền truy cập trang quản trị.",
        () => {
          localStorage.removeItem("token"); // Xóa token khỏi localStorage
          window.location.href = "/"; // Chuyển hướng người dùng
        }
      );
    } else if (response.ok) {
      // Nếu người dùng có quyền truy cập, chuyển hướng đến trang admin
      window.location.href = "/dashboard";
    } else {
      // Nếu có lỗi khác
      console.error("An error occurred while accessing the admin page.");
      showResultPopup("Lỗi", "Đã xảy ra lỗi không mong muốn.");
    }
  } catch (error) {
    console.error("Error while accessing admin page:", error);
    showResultPopup("Lỗi", "Không thể truy cập trang quản trị do lỗi không mong muốn.");
  }
}
  </script>